# Использование внешней компоненты

В каталоге /cf размещена конфигурация с обработкой `КафкаКоннектор.epf`, которая:
- Упрощает работу с компонентой через паттерн Коннектор
- Определяет программный интерфейс компоненты
- Форма обработки демонстрирует возможностей внешней компоненты

## Отправка сообщения:

При обычной отправке каждое сообщение ожидает ответ от брокера о доставке.

```bsl
Коннектор = Обработки.КафкаКоннектор.Создать();
Коннектор.Инициализировать("идентификатор-настройки-кафки");
Коннектор.ОтправитьСообщение("Текст сообщения", "Ключ сообщения", "Заголовок1: Значение");
Коннектор.Остановить();
```

## Отправка сообщения асинхронно:

При асинхронной отправке сообщения добавляются в очередь отправки [librdkafka](https://github.com/confluentinc/librdkafka), одновременно в этоже время [librdkafka](https://github.com/confluentinc/librdkafka) отправляет сообщения в брокер Кафки в несколько потоков и аккумулирует отчеты о доставке. В после постановки в очередь последнего сообщения компонента ожидает, когда librdkafka отправит все оставшиеся сообщения. Далее компонента проверяет по всем сообщениям статусы доставки, если какое-то не доставлено, возвращается ошибка.

```bsl
Коннектор = Обработки.КафкаКоннектор.Создать();
Коннектор.Инициализировать("идентификатор-настройки-кафки");

МассивСообщений = Новый Массив;
Сообщение = Коннектор.НовоеСообщение("Текст сообщения", "Ключ сообщения", "Заголовок1: Значение");
МассивСообщений.Добавить(Сообщение);

Коннектор.ОтправитьСообщения(МассивСообщений);
Коннектор.Остановить();
```

## Чтение сообщения:

```bsl
Коннектор = Обработки.КафкаКоннектор.Создать();
Коннектор.Инициализировать("идентификатор-настройки-кафки");
Сообщение = Коннектор.ПрочитатьСообщение();
МетаданныеСообщения = Коннектор.ПрочитатьМетаданныеСообщения();
Коннектор.Остановить();
```

## Известные проблемы

### Иеролифы вместо русского текста в сообщениях

> Рассмотрим пример для Linux, на Windows принцип такой же.

Проверьте наличие русской локали ru_RU и ru_RU.UTF-8:

```sh
locale -a
```
 
Если нет локали, её нужно добавить:

```
sudo locale-gen ru_RU
sudo locale-gen ru_RU.UTF-8
sudo update-locale 
```

Удалить лишние локали, если хотите вернуть все обратно:

```
1. Открыть файл `sudo nano /etc/locale.gen`
2. Закомментировать лишние локали
3. Сгенерировать локали `sudo locale-gen`
4. Обновить локали `sudo update-locale`
```

### Ошибка "OS doesn't support locale"

При инициализации компоненты с логированием может появиться ошибка `OS doesn't support locale`. Необходимо установить проверить наличие русской локали, решение описано выше.

